name: OpenRouter US-Only Cached Guardrail
description: Build and update an OpenRouter guardrail limited to US-based providers with prompt caching.
branding:
  icon: shield
  color: blue
inputs:
  provisioning_key:
    description: OpenRouter provisioning key.
    required: true
  guardrail_name:
    description: Guardrail name.
    required: false
    default: US Cached Models Only
  include_openai:
    description: Include OpenAI models and provider.
    required: false
    default: "false"
  include_google:
    description: Include Google models and providers.
    required: false
    default: "false"
  include_anthropic:
    description: Include Anthropic models and provider.
    required: false
    default: "false"
  upload_artifacts:
    description: Upload generated JSON artifacts.
    required: false
    default: "false"
runs:
  using: composite
  steps:
    - name: Validate provisioning key
      shell: bash
      run: |
        if [[ -z "${{ inputs.provisioning_key }}" ]]; then
          echo "Missing input: provisioning_key"
          exit 1
        fi

    - name: Fetch providers
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        OPENROUTER_INCLUDE_OPENAI: ${{ inputs.include_openai }}
        OPENROUTER_INCLUDE_GOOGLE: ${{ inputs.include_google }}
        OPENROUTER_INCLUDE_ANTHROPIC: ${{ inputs.include_anthropic }}
      run: ./scripts/fetch-providers.sh

    - name: Fetch cached models
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        OPENROUTER_PROVISIONING_KEY: ${{ inputs.provisioning_key }}
        OPENROUTER_MIN_THROUGHPUT_P50: ${{ env.OPENROUTER_MIN_THROUGHPUT_P50 }}
        OPENROUTER_MAX_LATENCY_P50: ${{ env.OPENROUTER_MAX_LATENCY_P50 }}
        OPENROUTER_INCLUDE_OPENAI: ${{ inputs.include_openai }}
        OPENROUTER_INCLUDE_GOOGLE: ${{ inputs.include_google }}
        OPENROUTER_INCLUDE_ANTHROPIC: ${{ inputs.include_anthropic }}
      run: ./scripts/fetch-cached-models.sh

    - name: Upload us-providers.json
      if: ${{ inputs.upload_artifacts == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: us-providers.json
        path: ${{ github.action_path }}/us-providers.json

    - name: Upload cached-models.json
      if: ${{ inputs.upload_artifacts == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: cached-models.json
        path: ${{ github.action_path }}/cached-models.json

    - name: Upload available-models.json
      if: ${{ inputs.upload_artifacts == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: available-models.json
        path: ${{ github.action_path }}/available-models.json

    - name: Upload allowed-providers.json
      if: ${{ inputs.upload_artifacts == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: allowed-providers.json
        path: ${{ github.action_path }}/allowed-providers.json

    - name: Update guardrail
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        OPENROUTER_PROVISIONING_KEY: ${{ inputs.provisioning_key }}
        OPENROUTER_GUARDRAIL_NAME: ${{ inputs.guardrail_name }}
      run: ./scripts/update-guardrail.sh
